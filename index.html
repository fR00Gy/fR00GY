<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Лягушонок ловит подарки</title>
  <style>
    html, body {
      margin: 0; padding: 0; width: 100vw; height: 100vh;
      overflow: hidden; font-family: sans-serif;
      background: url('https://i.imgur.com/4hoqU0E.png') no-repeat center center fixed;
      background-size: cover;
      display: flex; flex-direction: column; align-items: center;
    }
    canvas {
      background: rgba(255,255,255,0.8);
      border: 5px solid #333; width: 100vw; max-width: 400px;
      height: calc(100vh - 300px);
    }
    .controls { position: fixed; bottom: 10px; display: flex; justify-content: space-between; width: 300px; }
    .controls img { width: 60px; height: 60px; }
    #leaderboard { color: #fff; margin-top: 10px; }
    #leaderboard table { color: white; background: rgba(0,0,0,0.5); border-collapse: collapse; width: 100%; max-width: 400px; }
    #leaderboard th, #leaderboard td { padding: 5px 10px; border: 1px solid #ccc; text-align: left; }
  </style>
</head>
<body>
  <h1>Лягушонок ловит подарки</h1>
  <div id="scoreDisplay">Очки: 0</div>
  <button id="startGame">Старт</button>
  <canvas id="gameCanvas"></canvas>
  <div class="controls">
    <img src="https://i.imgur.com/QUaEIk9.png" id="left" />
    <img src="https://i.imgur.com/05AB2sm.png" id="right" />
  </div>
  <div id="leaderboard"></div>

<script>
  const SUPABASE_URL = "https://uhrmsevxbnqjptpuhprp.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocm1zZXZ4Ym5xanB0cHVocHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxOTQzODksImV4cCI6MjA1OTc3MDM4OX0.odCOrZw7JZHzFyKYtTBYhUbPfH_6ieynTmW7AfwBJpM";

  let user = { id: "anonymous", name: "Гость" };
  if (window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    const tg = Telegram.WebApp.initDataUnsafe;
    user = {
      id: tg?.user?.id?.toString() || "anonymous",
      name: tg?.user?.first_name || "Гость"
    };
  }

  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = 400; canvas.height = 500;
  let gameRunning = false, frogX = 155, frogY = 400, score = 0;
  const frogWidth = 50, frogHeight = 70;
  const gifts = [], giftSpeedBase = 2, giftPositions = [0, 50, 100, 150, 200, 250, 300, 350];
  let giftSpeed = giftSpeedBase, spawnInterval = 2000, lives = 3, spawnTimer;

  document.getElementById("startGame").onclick = () => {
    score = 0; lives = 3; gifts.length = 0; gameRunning = true;
    updateScoreDisplay(); this.style.display = 'none';
    startSpawning();
  };

  document.getElementById("left").onclick = () => frogX = Math.max(frogX - 50, 0);
  document.getElementById("right").onclick = () => frogX = Math.min(frogX + 50, canvas.width - frogWidth);

  function drawFrog() { ctx.fillStyle = 'green'; ctx.fillRect(frogX, frogY, frogWidth, frogHeight); }
  function drawGifts() {
    gifts.forEach((g, i) => {
      ctx.fillStyle = g.bad ? 'black' : 'red';
      ctx.fillRect(g.x, g.y, 30, 30);
      g.y += giftSpeed;
      if (g.y + 30 > frogY && Math.abs((g.x + 15) - (frogX + frogWidth / 2)) < 30) {
        if (g.bad) loseLife(); else score++;
        gifts.splice(i, 1); updateScoreDisplay();
      } else if (g.y > canvas.height) { gifts.splice(i, 1); if (!g.bad) loseLife(); }
    });
  }

  function updateScoreDisplay() {
    document.getElementById("scoreDisplay").innerText = `Очки: ${score}`;
  }

  function loseLife() {
    lives--;
    if (lives <= 0) {
      gameRunning = false;
      clearInterval(spawnTimer);
      saveScoreToSupabase(score);
      alert("Игра окончена! Ваш счёт: " + score);
      document.getElementById("startGame").style.display = 'block';
    }
  }

  function startSpawning() {
    spawnTimer = setInterval(() => {
      const x = giftPositions[Math.floor(Math.random() * giftPositions.length)];
      const isBad = Math.random() < 0.3;
      gifts.push({ x, y: 0, bad: isBad });
    }, spawnInterval);
  }

  function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (gameRunning) { drawFrog(); drawGifts(); }
    requestAnimationFrame(gameLoop);
  }

  gameLoop();
  fetchLeaderboardFromSupabase();

  async function saveScoreToSupabase(score) {
    await fetch(`${SUPABASE_URL}/rest/v1/scores`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({ user_id: user.id, username: user.name, score })
    });
    fetchLeaderboardFromSupabase();
  }

  async function fetchLeaderboardFromSupabase() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/scores?select=username,score&order=score.desc&limit=10`, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    });
    const data = await res.json();
    renderLeaderboard(data);
  }

  function renderLeaderboard(data) {
    const container = document.getElementById("leaderboard");
    container.innerHTML = '<h3>Топ игроков</h3>';
    const table = document.createElement("table");
    table.innerHTML = `<tr><th>Имя</th><th>Очки</th></tr>` +
      data.map(row => `<tr><td>${row.username}</td><td>${row.score}</td></tr>`).join('');
    container.appendChild(table);
  }
</script>
</body>
</html>
